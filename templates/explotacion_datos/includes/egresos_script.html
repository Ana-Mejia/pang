<script type="text/javascript">
    var mapObject;
    var myStyle = [
    {
    "featureType": "administrative",
    "elementType": "geometry",
    "stylers": [
        {
        "visibility": "off"
        }
    ]
    },
    {
    "featureType": "administrative.land_parcel",
    "stylers": [
        {
        "visibility": "off"
        }
    ]
    },
    {
    "featureType": "administrative.neighborhood",
    "stylers": [
        {
        "visibility": "off"
        }
    ]
    },
    {
    "featureType": "administrative.province",
    "stylers": [
        {
        "color": "#000000"
        },
        {
        "visibility": "off"
        },
        {
        "weight": 8
        }
    ]
    },
    {
    "featureType": "landscape",
    "stylers": [
        {
        "visibility": "off"
        }
    ]
    },
    {
    "featureType": "poi",
    "stylers": [
        {
        "visibility": "off"
        }
    ]
    },
    {
    "featureType": "poi",
    "elementType": "labels.text",
    "stylers": [
        {
        "visibility": "off"
        }
    ]
    },
    {
    "featureType": "poi.park",
    "stylers": [
        {
        "visibility": "off"
        }
    ]
    },
    {
    "featureType": "road",
    "stylers": [
        {
        "visibility": "off"
        }
    ]
    },
    {
    "featureType": "road",
    "elementType": "labels",
    "stylers": [
        {
        "visibility": "off"
        }
    ]
    },
    {
    "featureType": "road",
    "elementType": "labels.icon",
    "stylers": [
        {
        "visibility": "off"
        }
    ]
    },
    {
    "featureType": "transit",
    "stylers": [
        {
        "visibility": "off"
        }
    ]
    },
    {
    "featureType": "water",
    "stylers": [
        {
        "color": "#c7f6ff"
        },
        {
        "weight": 8
        }
    ]
    },
    {
    "featureType": "water",
    "elementType": "labels.text",
    "stylers": [
        {
        "visibility": "off"
        }
    ]
    }
    ];
</script>

<!-- jQuery -->
<script src="{% static 'vendors/jquery/dist/jquery.min.js' %}"></script>
<!-- Bootstrap -->
<script src="{% static 'vendors/bootstrap/dist/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'vendors/bootstrap/dist/js/bootstrap-slider.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
<!-- FastClick -->
<script src="{% static 'vendors/fastclick/lib/fastclick.js' %}"></script>
<!-- NProgress -->
<script src="{% static 'vendors/nprogress/nprogress.js' %}"></script>
<!-- Chart.js -->
<script src="{% static 'vendors/Chart.js/dist/Chart.min.js' %}"></script>
<!-- gauge.js -->
<script src="{% static 'vendors/gauge.js/dist/gauge.min.js' %}"></script>
<!-- bootstrap-progressbar -->
<script src="{% static 'vendors/bootstrap-progressbar/bootstrap-progressbar.min.js' %}"></script>
<!-- iCheck -->
<script src="{% static 'vendors/iCheck/icheck.min.js' %}"></script>
<!-- Skycons -->
<script src="{% static 'vendors/skycons/skycons.js' %}"></script>
<!-- Flot -->
<script src="{% static 'vendors/Flot/jquery.flot.js' %}"></script>
<script src="{% static 'vendors/Flot/jquery.flot.pie.js' %}"></script>
<script src="{% static 'vendors/Flot/jquery.flot.time.js' %}"></script>
<script src="{% static 'vendors/Flot/jquery.flot.stack.js' %}"></script>
<script src="{% static 'vendors/Flot/jquery.flot.resize.js' %}"></script>
<!-- Flot plugins -->
<script src="{% static 'vendors/flot.orderbars/js/jquery.flot.orderBars.js' %}"></script>
<script src="{% static 'vendors/flot-spline/js/jquery.flot.spline.min.js' %}"></script>
<script src="{% static 'vendors/flot.curvedlines/curvedLines.js' %}"></script>
<!-- DateJS -->
<script src="{% static 'vendors/DateJS/build/date.js' %}"></script>
<!-- JQVMap -->
<script src="{% static 'vendors/jqvmap/dist/jquery.vmap.js' %}"></script>
<script src="{% static 'vendors/jqvmap/dist/maps/jquery.vmap.world.js' %}"></script>
<script src="{% static 'vendors/jqvmap/examples/js/jquery.vmap.sampledata.js' %}"></script>
<!-- bootstrap-daterangepicker -->
<script src="{% static 'vendors/moment/min/moment.min.js' %}"></script>
<script src="{% static 'vendors/bootstrap-daterangepicker/daterangepicker.js' %}"></script>
<!-- jQuery autocomplete -->
<script src="{% static 'vendors/devbridge-autocomplete/dist/jquery.autocomplete.min.js' %}"></script>
<!-- ECharts -->
<script src="{% static 'vendors/echarts/dist/echarts.min.js' %}"></script>
<script src="{% static 'vendors/echarts/map/js/world.js' %}"></script>
<!-- jQuery multiselect -->
<script type="text/javascript" src="{% static 'vendors/pangeos/build/js/jquery-multiple-select/bootstrap-multiselect.js' %}"></script>
<!-- Custom Theme Scripts -->
<script src="{% static 'vendors/pangeos/build/js/custom.js' %}"></script>
<!-- INTROJS -->
<script src="{% static 'vendors/introjs/js/intro.min.js' %}"></script>
<!--MAPS  -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>

<script type="text/javascript" src="{% static 'vendors/html2canvas/html2canvas.js' %}"></script> 

<script src="{% static 'vendors/sweetalert/dist/sweetalert2.min.js' %}"></script>

<script type="text/javascript" src="{% static 'vendors/pangeos/pangeos.js' %}"></script>
<script type="text/javascript" src="{% static 'vendors/pangeos/indicadores/js/ayuda/pangeos-ayuda.js' %}"></script> 
<script type="text/javascript" src="{% static 'vendors/pangeos/pangeos-descargartabla.js' %}"></script>
<script type="text/javascript" src="{% static 'vendors/pangeos/pangeos-pdf.js' %}"></script>
<script type="text/javascript" src="{% static 'vendors/geoxml3/js/geoxml3.js' %}"></script>

<script type="text/javascript">
    var cdmxkml="5";
    var layer = [];

    var array_kml = [
        'aguascalientes',
        'bajacalifornia',
        'bajacaliforniasur',
        'campeche',
        'chiapas',
        'chihuahua',
        'cdmx',
        'coahuila',
        'colima',
        'durango',
        'guanajuato',
        'guerrero',
        'hidalgo',
        'jalisco',
        'mexico',
        'michoacan',
        'morelos',
        'nayarit',
        'nuevoleon',
        'oaxaca',
        'puebla',
        'queretaro',
        'quintanaroo',
        'sanluispotosi',
        'sinaloa',
        'sonora',
        'tabasco',
        'tamaulipas',
        'tlaxcala',
        'veracruz',
        'yucatan',
        'zacatecas'
    ];
    
    var addListenersOnPolygon = function(polygon) {
        google.maps.event.addListener(polygon, 'click', function (event) {
        // alert(polygon.indexID);
        });  
    }

    let mapa_data = [];
    let mapa_max = 0;
    let data_distribucion_entidad = [];
    let anio = ""
    let anios_array = []
    let entidades = []
    let tbDistribucion = []

    $(document).ready(function(){
        let gTheme = init_echarts();

        /* ******************************************************************************** */
        /* INICIAL */
        /* Controles */
        let regiones = "{{ regiones | safe }}";
        let sexo = "{{ sexo }}";
        anio = "{{ anio_cubo_nac }}";
        anios_array = JSON.parse(JSON.stringify(format_data_python("{{ anios_array | safe }}"))) /* Origin Array */
        entidades = format_data_python("{{ entidades | safe }}") /* Origin Array */
        console.log("entidades: ")
        console.log(entidades)

        $("#crearimagen").click(function() { 
            downloadCanvas('content_gb', name_file_base+'_edades.png');
        });
        $("#crearimagen_pastel").click(function() { 
            downloadCanvas('content_gp', name_file_base+'_medio.png');
        });
        $("#crearimagen_distribucion").click(function() { 
            downloadCanvas('content_distribucion', name_file_base+'_distribucion_entidad.png');
        });
        $("#ficha_indicador").click(function() { 
            pdf_ficha(); /* pangeos-pdf.js */
        });
    });

    function downloadCanvas(canvasId, filename) {
        console.log("fn.downloadCanvas");
        // Obteniendo la etiqueta la cual se desea convertir en imagen
        var domElement = document.getElementById(canvasId);

        // Utilizando la función html2canvas para hacer la conversión
        html2canvas(domElement, {
            useCORS: true,
            //backgroundColor: "#ffffff"
        }).then(canvas => {
            dataURL = canvas.toDataURL("image/jpeg", 1.0);
            var a = document.createElement('a');
            a.href=dataURL.replace("image/jpeg", "image/octet-stream");
            a.download = filename;
            a.click();
        });
    }


    
    

    function initMap() {
        mapObject = new google.maps.Map(document.getElementById('googleMaps'), {
            mapTypeControlOptions: {
                mapTypeIds: ['mystyle', google.maps.MapTypeId.ROADMAP, google.maps.MapTypeId.TERRAIN]
            },
            center: new google.maps.LatLng(24.0701514,-100.9255709),
            streetViewControl: false,
            mapTypeControl: false,
            disableDefaultUI: true,
            zoomControl: true,
            zoom: 5,
            mapTypeId: 'mystyle'
        });

        mapObject.mapTypes.set('mystyle', new google.maps.StyledMapType(myStyle, { name: 'My Style' }));
        var bounds = new google.maps.LatLngBounds();
    }

    jQuery("#filtroBuscar").click(function(){
        if( arrayKML.length == 0 ) {
            Swal.fire({
            title: '¡Error!',
            text: 'Es necesario indicar al menos un municipio. Inténtalo nuevamente.',
            icon: 'error',
            confirmButtonText: 'Aceptar'
            });
            return false;
        }
        if( arrayFiles.length > 0 ) {
            for (i = 0; i < layer.length; i++) {
            if( layer[i] !== null ) {
                layer[i].setMap(null);
                layer[i]=null;
            }
            }
            jQuery.ajax({
                url: 'crearKML.php',
                method: 'post',
                data: {data: JSON.stringify(arrayFiles) },
                success: function(t) {
                    _obj = jQuery.parseJSON(t);
                    var r = "https://demoinp.gaipp.mx/production/tmp/";
                    jQuery("#filtroLimpiar").css({"display":"block"});
                    jQuery("#filtroGrafica").css({"display":"block"});
                    jQuery("#geochart-colors").css({"display":"none"});
                    jQuery("#googleMaps").css({"display":"block"});
                    for (var i = 0; i < _obj.length; i++) {
                        src = r+_obj[i];
                        if(!isExistsKML(src)){
                            showKML(src);
                        }
                    }                    
                    jQuery("#btnMostrarImagen").css({"display":"block"});
                    jQuery("#btnMostrarMapa").css({"display":"block"});
                    setTimeout(centerMap, 1000);

                    // arrayFiles=[];
                }
            });
        }
    });

    jQuery("#btnMostrarImagen").click(function(){
        dataMap();
    });

    jQuery("#btnMostrarMapa").click(function(){
        cambiaMapa('a');
    });

    jQuery("#fullScreen").click(function(){
        cambiaMapa('r');
    });

    function centerMap(){
        for (i = 0; i < layer.length; i++) {
            if( layer[i] !== null ) {
                if (typeof bounds === "undefined") {
                    bounds = layer[i].getDefaultViewport();
                } else {
                    bounds.union(layer[i].getDefaultViewport());
                }
            }
            mapObject.fitBounds(bounds);
        }
        bounds = new google.maps.LatLngBounds();;
    }

    function isExistsKML(_kml) {
        for (i = 0; i < layer.length; i++) {
            if(layer[i] !== null && layer[i].url == _kml ) {
                return true;
            }
        }
        return false
    }

    function showKML(kml) {
        // var myParser = new geoXML3.parser({map: mapObject});
        var kmlLayer = new google.maps.KmlLayer({
            url: kml,
            map: mapObject
        });

        google.maps.event.addListener(kmlLayer, 'click', function(kmlEvent) {
            var text = kmlEvent.featureData.description;
        });

        // myParser.parse(kml);
        layer.push(kmlLayer);
    }

    function limpiarFormulario(){
        jQuery("#estadosselector").html('<option value="0">-- Seleccionar estado</option>');
        jQuery("#regionselector").val(0);
        for (i = 0; i < layer.length; i++) {
        if( layer[i] !== null ) {
            layer[i].setMap(null);
            layer[i]=null;
        }
        }
        municipiosSEL=[];
        arrayKML=[];
        arrayFiles=[];
        layer=[];
        jQuery(".btag").remove();
        jQuery("#estadosselector").children("option").css({"display":"block"});
        jQuery("#geochart-colors").css({"display":"block"});
        jQuery("#googleMaps").css({"display":"none"});
        jQuery('#dropmunicipios').html('');
        jQuery('#dropmunicipios').multiselect('destroy');
        jQuery("#btnMostrarImagen").css({"display":"none"});
        jQuery("#btnMostrarMapa").css({"display":"none"});
    }

    jQuery("#filtroLimpiar").click(function(){
        limpiarFormulario();
    });


    function dataMap() {
        var c = mapObject.getCenter();
        var z = mapObject.getZoom();
        jQuery(".modal-googleMaps").css( { "width": parseFloat(((jQuery("#googleMaps").css("width")).replace("%","")).replace("px",""))+32+"px", "height": parseFloat(((jQuery("#googleMaps").css("height")).replace("%","")).replace("px",""))+32+"px", "display":"none" } );
            html2canvas( document.querySelector("#googleMaps"),
            {
                useCORS: true
            }).then(canvas => {
                dataURL = canvas.toDataURL("image/jpeg", 1.0);
                var a = document.createElement('a');
                a.href=dataURL.replace("image/jpeg", "image/octet-stream");
                a.download = 'pangeos.jpg';
                a.click();
            jQuery("#modalImageMap").html('');
            jQuery("#modalImageMap").append(canvas);
            jQuery("#modalImageMap").css({"display":"none"});
        });
    }

    function switchMaps(){
        var gmd=jQuery("#googleMaps").css("display");
        if(gmd=="none") {
        jQuery("#geochart-colors").css({"display":"none"});
        jQuery("#googleMaps").css({"display":"block"});
        } else {
        jQuery("#geochart-colors").css({"display":"block"});
        jQuery("#googleMaps").css({"display":"none"});
        }
    }
    
    function cambiaMapa(s) {
        switch(s) {
            case 'a':
                jQuery("#controles").css({"right":"-353px"});
                jQuery("#fullScreen").css({"display":"block"});
                jQuery("#googleMaps").css({"position":"fixed", "display":"block", "width":"100vw", "height":"100vh", "z-index":"99", "left":"0px", "top":"0px"});
            break;
            case 'r':
                jQuery("#controles").css({"right":"-325px"});
                jQuery("#fullScreen").css({"display":"none"});
                jQuery("#googleMaps").css({"position":"relative", "display":"block", "width":"100%", "height":"462px", "z-index":"10"});
            break;
        }
        centerMap();
    }

    </script>
    <script defer async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA09vQhZhG6svDBJaik7Xs3vO0vmSvqCYE&callback=initMap"></script>
</script>