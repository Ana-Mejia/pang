<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <!-- Meta, title, CSS, favicons, etc. -->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        {% load static %}
        <link rel="icon" href="{% static 'vendors/pangeos/production/images/favicon.ico' %}" type="image/ico" />

        <title>PANGEOS-MX</title>
        <!-- <link href="../vendors/fontawesome/css/font-awesome.min.css" rel="stylesheet"> -->

        <!-- Bootstrap -->
        <link href="{% static 'vendors/bootstrap/dist/css/bootstrap.min.css' %}" rel="stylesheet" />
        <!-- Font Awesome -->
        <!-- <link href="../vendors/pangeos/build/fonts/fontawesome/css/all.css" rel="stylesheet"> -->
        <link href="{% static 'vendors/font-awesome/css/font-awesome.min.css' %}" rel="stylesheet">

        <!-- NProgress -->
        <link href="{% static 'vendors/nprogress/nprogress.css' %}" rel="stylesheet">
        <!-- Animate.css -->
        <link href="{% static 'vendors/animate.css/animate.min.css' %}" rel="stylesheet">

        <!-- SWEETALERT -->
        <link href="{% static 'vendors/sweetalert/dist/sweetalert2.min.css' %}" rel="stylesheet"/>

        <link href="{% static 'vendors/pangeos/css/pangeos-login.css' %}" rel="stylesheet">


        <!-- Custom Theme Style -->
        <link href="{% static 'vendors/pangeos/build/css/custom.css' %}" rel="stylesheet">
        <style type="text/css">
            #serveranswer { display: none; }
            /*#loginform {
                background-color: #fcfcfc !important;
                padding: 15px !important;
                border-radius: 20px !important;
                -webkit-box-shadow: 5px 5px 5px 5px #540019;
                box-shadow: 5px 5px 5px 5px #540019;
                border: 2px solid #FF014C;
            }
            #loginform h1:after, #loginform h1:before {
                content: "" !important;
                height: 0px !important;
                width: 0px !important;
            }
            #btnLogin {
                font-size: 1.1em;
                font-weight: bolder;
                text-decoration: underline;
            }
            .login-btn_wrapper {
                margin: 15px auto 30px auto;
            }
            .refresh-captcha {
                color: #008;
                cursor: pointer;
                font-size: 0.5em;
                cursor: pointer;
                font-size: 0.7em;
                line-height: 1.3em;
                text-transform: capitalize;
            }*/
        </style>
        <script src="https://use.fonticons.com/ffe176a3.js"></script>
    </head>

<body class="login">
    <div>
        <a class="hiddenanchor" id="signup"></a>
        <a class="hiddenanchor" id="signin"></a>

        <div class="login_wrapper">
            <div class="animate form login_form">
            <section class="login_content">
                    <form id="loginform" action="{% url 'admin_sistema:enviar_recuperar' %}" method="POST">
                        {% csrf_token %}
                        <div class="">
                            <!-- <h1 class="item"><img src="{% static 'vendors/pangeos/production/images/conacyt-gde.png' %}" ></h1> -->
                            <h1 class="item"><div id="logo-login"></div></h1>
                        </div>
                        <div>
                        <input type="email" id="usuario" name="email" class="form-control" placeholder="Ingresa el correo con el cual te registraste" required="" pattern="[a-zA-Z0-9_]+([.][a-zA-Z0-9_]+)*@[a-zA-Z0-9_]+([.][a-zA-Z0-9_]+)*[.][a-zA-Z]{1,5}"/>
                        </div>
                        <div class="row">
                            <div class="col-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
                                <div class="form-group">
                                    <label for="captcha">Ingresa los caracteres mostrados</label>
                                    <img src="{% static 'captcha/c.png' %}" alt="CAPTCHA" id="img_captcha"> <!-- class="captcha-image" -->
                                    <i class="fa fa-redo refresh-captcha"> Refrescar captcha</i> 
                                    <input type="text" class="form-control" id="captcha" name="captcha_challenge" pattern="[A-Z0-9]{4}" placeholder="Captcha">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="button" class="btn btn-danger">Cancelar</button>
                                <button type="submit" class="btn btn-success" id="enviar">Aceptar</button>
                            </div>
                        </div>
                        <div class="clearfix"></div>
                    </form>
            </section>
            </div>
        </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="{% static 'vendors/validator/multifield.js' %}"></script>
    <script src="{% static 'vendors/validator/validator.js' %}"></script>
    <script src="{% static 'vendors/pangeos/production/js/owlcarousel/dist/owl.carousel.js' %}"></script>
    <script src="{% static 'vendors/sweetalert/dist/sweetalert2.min.js' %}"></script>

    <script type="text/javascript" src="{% static 'vendors/pangeos/pangeos.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendors/pangeos/pangeos-recuperarcontrasena.js' %}"></script>
    <script>
        $(document).ready(function() {
            let csrf_token = "{{ csrf_token }}";

            let captcha_back = "{{ chars }}";
            captcha_back = captcha_back.replace(/&#x27;|'|,| |\s|\[|\]/g,"");
            console.log(captcha_back);

            $(".refresh-captcha").click(function(){
                var settings = {
                    "url": "{% url 'admin_sistema:get_image' %}",
                    "method": "GET",
                    "timeout": 0,
                };
                
                $.ajax(settings).done(function (response) {
                    console.log(response);
                    captcha_back = response;
                    document.getElementById("img_captcha").src = "{% static 'captcha/c.png' %}" + "?" + Date();
                });
            });

            $("#loginform").submit(function(e) {
                e.preventDefault(); // prevent actual form submit
                var form = $(this);
                var url = form.attr('action'); //get submit url [replace url here if desired]
                
                if(!validarCaptcha(captcha_back)){
                    console.log("Wrong captcha");
                      Swal.fire({
                        title: '¡Error!',
                        text: 'Error al capturar el Captcha',
                        icon: 'error',
                        confirmButtonText: 'Aceptar'
                      });
                    return false;
                }

                //Petición ajax para guardar el form y regresar un estatus del guardado
                $.ajax({
                    type: "POST",
                    url: url, // enviar_recuperar
                    data: form.serialize(), // serializes form input
                    dataType: 'json',
                    headers: {
                        csrfmiddlewaretoken: csrf_token,
                    },
                    success: function(data){
                        console.log(data.status);
                        console.log(data.msg);
                          Swal.fire({
                            title: 'PANGEOS dice:',
                            text: data.msg,
                            icon: 'info',
                            confirmButtonText: 'Aceptar'
                          });
                        return false;
                        // window.location = "http://10.249.21.180/";
                    }
                });
            });

            $(".btn-danger").click(function(){
                window.location = "http://10.249.21.180/";
            });
        });

        // Function input Captcha
        function validarCaptcha(captcha_back){
            console.log("Captcha_back: " + captcha_back);
            var captcha_input = $("#captcha").val();
            console.log("Captcha_input: " + captcha_input);
            if( captcha_back == captcha_input )
                return true
            else
                return false
        }
    </script>
</body>

</html>
